{"version":3,"file":"/server/main.coffee.js","sources":["main.coffee"],"names":[],"mappings":";AAAA;;GAAS,GAAT,CAAS;;AACT,CADA,EACA,EAAM,CAAM,CAAN;;AAEN,CAHA,CAGsC,CAAtC,GAAM,GAAgC,SAAtC;CACE;;IAAU;CAAV,CAEA,EAAC,IAAQ,CAAT;CAFA,CAIA,CAAa,OAAb,CAAa;CAJb,CAUA,EAAM,GAAoB,CAAZ,CAAa;CACxB,CAAiB,CAAlB,CAAkB,KAAC,CAAnB;CACE,GAAG,CAAQ,CAAX;CACE,MAAc,GAAP;OADT;CAEA,GAAG,CAAQ,CAAX;CACE,MAAc,QAAP;OAHT;CAIA,GAAG,CAAQ,CAAX;CACE,cAAO;OALT;CAMA,GAAG,CAAQ,CAAX;CACE,MAAc,QAAP;OAPT;CAQA,GAAG,CAAQ,CAAX;CACE,cAAO;OATT;CAUA,GAAG,CAAQ,CAAX;CACE,cAAO;OAXT;CAYA,GAAG,CAAQ,CAAX;CACE,cAAO;OAbT;CAcA,GAAG,CAAQ,CAAX;CACE,cAAO;OAfT;CAgBA,GAAG,CAAQ,CAAX;CACE,cAAO,wBAAP;OAjBF;CAkBA,GAAG,CAAQ,CAAX;CACE,cAAO;OAnBT;CAoBA,GAAG,CAAQ,CAAX;CACE,cAAO,2LAAP;OArBF;CAsBA,YAAO;CAvBT,IAAkB;CADd,EAAoB;CAV1B,CAoCA,CAAG,IAAH;CApCA,CAsCA,OAAwC;CACtC,IAAC,GAAQ;CACL,EAAD,QAAH;CAFF,EAAwC;CAIpC,EAAD,CAAH;CA3CoC;;AA8CtC,CAjDA,CAiDyB,CAAT,MAAC,IAAjB;CACE;;GADyC,CAAR;GACjC;GAAQ,EAAR;;;;CAAqB,EAAb,CACD,CADC,IACA,QADA;CAEc,CAAmB,EAArC,aAAiB;CAFb,EACD,IAEA,EAAC;CACG,GAAP,EAAM,CAAN;CAJI,EAGD,GAEA,GAAC;CACG,EAAP,GAAM,KAAN;CANI,EAKD,IALC,EAQA;CACJ,MAAO;CAAQ,CAAO,EAAN,GAAa;EAAQ,CAAS,GAA9C,GAA8C;CACtC,CAAe,GAAhB,CAAL;CAAqB,CAAQ,EAAN;CAAM,CAAoB,QAAlB;SAAV;CADuB,OAC5C;CADF,IAA8C;CAEtC,MAAD,IAAP;CAXI,EAQD,EARC;CAcF,IAAD,CAAL;CAAa,CAAW,EAAV;EAAqB,EAAnC;CAAmC,CAAW,EAAV;CAAD,CAAoC,EAAf,CAArB,QAAqB;EAAuB,EAA/E,KAA+E;CACvE,CAAe,GAAhB,CAAL;CAAqB,CAAQ,EAAN;CAAM,CAAqB,MAAnB;OAAV;CADwD,KAC7E;CADF,EAA+E;CAfjE;;AAmBhB,CApEA,KAoEM,CAAN;CACE,EAAQ,GAAR,GAAS,KAAD;CACA,IAAD,CAAL;CACE,CAAgB,IAAhB;EACmB,IAAnB;CADA,CAEkB,IAAlB;CAFA,CAGS,IAAT;CAHA,CAIe,IAAf;CANI,KACN;CADF,EAAQ;CAAR,CAOA,CAAU,KAAV,CAAW;CACT;GAAO,CAAP,CAAY,CAAL;CACC,KAAR,CAAO,IAAP;CACE,CAAM,EAAN;EACS,IAAT;CADA,CAEY,EAAI,EAAhB;CALM,KAER;CATF,EAOU;CAPV,CAaA,CAAc,MAAC,GAAf;CACE;;GAD2C,GAAR;KACnC;EACkB,CADP,CAAX,CAAW,GAAX,CACQ,GADG;CAMO,CAAiB,GAA/B;CANO,IACJ,EAMA,EAAC;CACG,CAAuB,EAA9B,EAAM,CAAM,EAAmB,IAA/B;CAA8B,KAC5B,MAAkB,GAAlB;CADU,MAAkB;CARvB,IAOJ,CAGA,GAAC;CACJ,GAAG,EAAH,MAAqB;CAAmB,EAAP,GAAM,SAAN;MAAjC;eAAmD;OADhD;CAVI,IAUJ;CAVP,EAaU,CAAV;CAAuB,CAAK,CAAL;CAAK,CAAK,CAAL;OAAL;CAAmB,IAAhC;CAbV,EAcW,CAAX,CAAgB,EAAL,CAAX,UAAW;CAdX,EAgBW,CAAX;AACA;;CACE,CAA4B,EAA5B,CAAY,CAAZ,GAA6B,IAA7B;CACE,EAAmD,CAAhD,CAAkB,CAAlB,EAAH;CACW,EAAQ,CAAR,aAAT;SAFwB;CAA5B,MAA4B;CAD9B,IAjBA;EAsB8B,CAAnB,CAAX,EAAW,CAAmB,CAA9B,CAA+B;CACpB,MAAO,CAAP,KAAT;CADS,IAAmB;CAtB9B,CAwB6B,CAAhB,CAAb,GAA6B,CAAhB,CAAiB,CAA9B;CACU,MAAD,MAAP;CADW,IAAgB;CAEvB,CAAe,GAAhB,CAAL;CAAqB,CAAO,EAAN;CAAM,CAAa,MAAZ;OAAR;CA3BT,KA2BZ;CAxCF,EAac;CAbd,CA0CA,CAAY,MAAC,CAAb;CACE;GAAU,CAAV,IAAkB,EAAR;AACH,CAAP,MAAc,GAAP;CACL,EAAU,GAAV,YAAU;CAAV,KACA,EAAQ;CAAQ,CAAM,CAAL,OAAD;EAAmB,MAAnC;CAAmC,CAAO,EAAN,GAAD,CAAC;CADpC,OACA;CACS,MAAT,CAAQ,EAAR;KALQ;CA1CZ,EA0CY;CA1CZ,CAiDA,CAAa,MAAC,EAAd;CACE;AAAO,CAAP,MAAO,CAAQ;CAAS,CAAY,IAAX;CAAzB,KAAO;CACL,EAAU,GAAV,EAAkB,CAAR;CACV,GAAG,EAAH;CACU,CAAqB,GAA7B,EAAO,CAAP;OAHJ;KADW;CAjDb,EAiDa;CAtHf,CAoEA;;AAwDA,CA5HA,EA4HyB,KAAjB,CAAkB,MAA1B;CACE,GAAI,CAAiB,CAAjB,CAAJ,CAAI;CACF,UAAO;GAFc;;A","sourcesContent":["Future = Meteor.require 'fibers/future'\nCSV = Meteor.require 'csv'\n\nMeteor.Router.add '/listings/export', ->\n  fut = new Future();\n\n  @response.setHeader 'Content-Disposition', 'attachment; filename=listings.csv;'\n\n  properties = ['sku', 'product-id', 'product-id-type',\n                'price', 'item-condition', 'quantity',\n                'add-delete', 'will-ship-internationally',\n                'expedited-shipping', 'standard-plus',\n                'item-note', 'fulfillment-center-id',\n                'product-tax-code', 'leadtime-to-ship']\n  res = Listings.find().map (listing) ->\n    _.map properties, (name) ->\n      if name == 'sku'\n        return listing.computeSKU()\n      if name == 'product-id'\n        return listing.asin\n      if name == 'product-id-type'\n        return 1 # ASIN = 1\n      if name == 'price'\n        return listing.price\n      if name == 'item-condition'\n        return 11 # New?\n      if name == 'quantity'\n        return 40\n      if name == 'add-delete'\n        return 'a'\n      if name == 'will-ship-internationally'\n        return 'y'\n      if name == 'expedited-shipping'\n        return 'Next, Second, Domestic, International'\n      if name == 'leadtime-to-ship'\n        return 1\n      if name == 'item-note'\n        return 'Brand New Compatible Battery, Superior Tech Rover Quality, 30-Day Any Reason Return Policy with Unmatched Tech Rover Customer Service! Buy with confidence from a knowledgeable US seller you can trust.'\n      return ''\n\n  res.unshift properties\n\n  CSV().from(res).to(@response).on 'end', =>\n    @response.end()\n    fut.return()\n\n  fut.wait()\n\n\n_searchAmazon = (loadId, keywords, pages = 2) ->\n  asins = _([1..pages]).chain()\n    .map (page) ->\n      scrapAmazonSearch.future()(keywords, page)\n    .tap (futures) ->\n      Future.wait futures\n    .map (future) ->\n      future.get()\n    .flatten()\n    .map (product) ->\n      Product.upsert {asin: product.asin}, product, ->\n        Loads.update(loadId, { $inc: { productProcessed: 1 } })\n      product.asin\n    .value()\n\n  Query.upsert {keywords: keywords}, {keywords: keywords, matched_asins: asins}, ->\n    Loads.update(loadId, { $inc: { keywordsProcessed: 1 } })\n\n\nMeteor.methods\n  doLoad: (keywordsAmount) ->\n    Loads.insert\n      keywordsAmount: keywordsAmount\n      keywordsProcessed: 0\n      productProcessed: 0\n      ownerId: Meteor.userId()\n      createdAt: new Date()\n  saveLoad: (loadId, name) ->\n    load = Loads.findOne loadId\n    Results.insert\n      name: name\n      ownerId: Meteor.userId()\n      productIds: load.productIds\n  searchAmazon: (loadId, keywordsList, pages = 2) ->\n    queryIds = _.chain(keywordsList)\n      .map (keywords, index) ->\n        # query = Queries.findOne keywords: keywords\n        # if query\n          # query._id\n        # else\n        _searchAmazon.future()(loadId, keywords, pages)\n      .tap (results) ->\n        Future.wait _.filter results, (result) ->\n          result instanceof Future\n      .map (result) ->\n        if result instanceof Future then result.get() else result\n      .value()\n    queries = Queries.find(_id: $in: queryIds).fetch()\n    products = Query.allMatchedProducts(queries).fetch()\n\n    ordering = {}\n    for query in queries\n      _.each query.matched_asins, (asin, index) ->\n        if ordering[asin] == undefined || ordering[asin] > index\n          ordering[asin] = index\n\n    products = _.sortBy products, (product) ->\n      ordering[product.asin]\n    productIds = _.map products, (product) ->\n      product._id\n    Loads.update loadId, {$set: {productIds: productIds}}\n\n  getDetails: (product_id) ->\n    product = Products.findOne(product_id)\n    unless product.hasDetails()\n      details = scrapAmazonProduct(product.asin)\n      Products.update {_id: product_id}, {$set: details}\n      Products.findOne(product_id)\n\n  listProduct: (productId, price, baseSKU, original) ->\n    unless Listings.findOne {productId: productId}\n      product = Products.findOne(productId)\n      if product\n        product.createListing price, baseSKU, original\n\nAccounts.validateNewUser (user) ->\n  if (user.username == 'tony' || user.username == 'brian')\n    return true\n\n# Meteor.startup ->\n#   if Listings.find().count() == 0\n#     for i in [0..10]\n#       Listings.insert\n#         status: 'Acitve' # a / d / x Active, Hidden, Remove. Corresponds to amazon add/delete\n#         asin: 'B004XUU5RG'\n#         sku: 'Dell-1464-L102-6C-CN39-C1001'\n#         price: 11.14\n#         quantity: 10\n#         condition: 'New'\n#         leadtimeToShip: 2\n#         willShipInternationally: true\n#         expeditedShipping: 'Next, Second'\n#         standardPlusShipping: true\n#         note: 'Brand New Compatible Battery, Superior Tech Rover Quality, 30-Day Any Reason Return Policy with Unmatched Tech Rover Customer Service! Buy with confidence from a knowledgeable US seller you can trust.'\n\n"]}